<!DOCTYPE html>
<html lang="zh">

<head>
  <meta charset="UTF-8">
  <title>CyberDice 2077</title>
  <!-- ä½¿ç”¨ç¨³å®šçš„ CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"
    type="application/javascript"></script>
  <link
    href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Roboto+Mono:wght@300;500&display=swap"
    rel="stylesheet">
  <style>
    /* Cyberpunk Theme CSS */
    :root {
      --neon-blue: #00f3ff;
      --neon-pink: #bc13fe;
      --bg-dark: #050510;
      --glass: rgba(255, 255, 255, 0.05);
      --border-color: rgba(0, 243, 255, 0.3);
    }

    body {
      background-color: var(--bg-dark);
      color: #fff;
      font-family: 'Roboto Mono', monospace;
      margin: 0;
      min-height: 100vh;
      background-image: radial-gradient(circle at 50% 50%, #1a1a2e 0%, #000 100%);
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    /* é¡¶éƒ¨æ ‡é¢˜æ  */
    header {
      margin-top: 30px;
      text-align: center;
    }

    h1 {
      font-family: 'Orbitron', sans-serif;
      font-size: 3rem;
      text-shadow: 0 0 10px var(--neon-blue), 0 0 20px var(--neon-blue);
      margin-bottom: 5px;
      letter-spacing: 5px;
    }

    .subtitle {
      color: var(--neon-pink);
      text-transform: uppercase;
      letter-spacing: 2px;
      margin-bottom: 30px;
    }

    /* ä¸»å¸ƒå±€ï¼šå·¦å³åˆ†æ  */
    .layout-wrapper {
      display: flex;
      flex-wrap: wrap;
      gap: 30px;
      width: 90%;
      max-width: 1200px;
      justify-content: center;
      align-items: flex-start;
      margin-bottom: 50px;
    }

    .game-section {
      flex: 1;
      min-width: 350px;
      max-width: 600px;
    }

    .info-section {
      flex: 0.6;
      min-width: 300px;
      max-width: 400px;
    }

    /* é¢æ¿æ ·å¼ */
    .panel {
      background: var(--glass);
      border: 1px solid var(--border-color);
      border-radius: 15px;
      padding: 25px;
      margin-bottom: 20px;
      backdrop-filter: blur(10px);
      box-shadow: 0 0 15px rgba(0, 243, 255, 0.1);
      transition: transform 0.2s;
    }
    
    .panel:hover {
      box-shadow: 0 0 25px rgba(0, 243, 255, 0.2);
    }

    .panel h3 {
      margin-top: 0;
      color: var(--neon-blue);
      border-bottom: 1px solid var(--border-color);
      padding-bottom: 10px;
      font-family: 'Orbitron';
    }

    /* æŒ‰é’®ä¸è¾“å…¥æ¡† */
    .btn {
      background: rgba(0, 243, 255, 0.1);
      border: 1px solid var(--neon-blue);
      color: var(--neon-blue);
      padding: 10px 20px;
      font-family: 'Orbitron', sans-serif;
      cursor: pointer;
      transition: 0.3s;
      text-transform: uppercase;
      font-weight: bold;
      width: 100%;
    }

    .btn:hover {
      background: var(--neon-blue);
      color: #000;
      box-shadow: 0 0 20px var(--neon-blue);
    }

    .btn-pink {
      border-color: var(--neon-pink);
      color: var(--neon-pink);
      background: rgba(188, 19, 254, 0.1);
    }

    .btn-pink:hover {
      background: var(--neon-pink);
      color: #fff;
      box-shadow: 0 0 20px var(--neon-pink);
    }

    .row {
      display: flex;
      gap: 10px;
      align-items: center;
      justify-content: space-between;
      margin: 15px 0;
    }

    input {
      background: rgba(0, 0, 0, 0.5);
      border: 1px solid #333;
      color: #fff;
      padding: 10px;
      width: 100%;
      font-family: 'Roboto Mono', monospace;
      text-align: center;
      font-size: 1rem;
    }
    
    input:focus {
        outline: none;
        border-color: var(--neon-blue);
    }

    /* çŠ¶æ€æ˜¾ç¤º */
    .stat-value {
      font-weight: bold;
      color: #fff;
      font-size: 1.1rem;
    }

    .win { color: #0f0; text-shadow: 0 0 10px #0f0; font-weight: bold; }
    .lose { color: #f00; text-shadow: 0 0 10px #f00; font-weight: bold; }

    #console-log {
      font-size: 12px;
      color: #888;
      height: 120px;
      overflow-y: auto;
      border-top: 1px solid #333;
      padding-top: 10px;
      font-family: monospace;
    }

    /* è¯´æ˜æ–‡æœ¬ */
    .info-text p {
        font-size: 0.9rem;
        line-height: 1.6;
        color: #ccc;
        margin-bottom: 10px;
    }
    .info-text strong { color: var(--neon-blue); }
    .highlight { color: var(--neon-pink); }

    /* Loading é®ç½© */
    .glitch-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.85);
      z-index: 999;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      color: var(--neon-blue);
      font-family: 'Orbitron';
      font-size: 1.5rem;
    }
    .spinner {
        border: 4px solid rgba(0, 243, 255, 0.1);
        border-top: 4px solid var(--neon-blue);
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin-bottom: 20px;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

  </style>
</head>

<body>

  <div class="glitch-overlay" id="loading">
      <div class="spinner"></div>
      <div id="loading-text">TRANSACTION PENDING...</div>
  </div>

  <header>
      <h1>CYBERDICE 2077</h1>
      <div class="subtitle">å»ä¸­å¿ƒåŒ–åšå½©åè®®</div>
  </header>

  <div class="layout-wrapper">
    
    <!-- å·¦ä¾§ï¼šæ¸¸æˆæ“ä½œåŒº -->
    <div class="game-section">
        <!-- è¿æ¥é¢æ¿ -->
        <div class="panel">
          <div class="row">
            <span id="wallet-addr" style="font-size: 0.9rem;">ğŸ”´ æœªè¿æ¥é’±åŒ…</span>
            <button class="btn" id="connect-btn" onclick="connectWallet()" style="width: auto;">LINK START</button>
          </div>
          <div class="row" style="background: rgba(0,0,0,0.3); padding: 10px; border-radius: 5px;">
            <span>ETH: <span id="eth-bal" class="stat-value">0.00</span></span>
            <span>CYBER: <span id="token-bal" class="stat-value">0.00</span></span>
          </div>
        </div>

        <!-- äº¤æ˜“æ‰€é¢æ¿ -->
        <div class="panel">
          <h3>1. ç­¹ç äº¤æ˜“æ‰€ (Exchange)</h3>
          <p style="font-size: 0.8rem; color: #888; margin-bottom: 15px;">å½“å‰æ±‡ç‡: 1 ETH = 1000 CYBER</p>
          
          <div class="row">
            <input type="number" id="buy-amount" placeholder="è¾“å…¥ ETH æ•°é‡" step="0.01">
            <button class="btn" onclick="buyTokens()" style="width: 120px; margin-left: 10px;">ä¹°å…¥</button>
          </div>
          
          <div class="row">
            <input type="number" id="sell-amount" placeholder="è¾“å…¥ CYBER æ•°é‡" step="100">
            <button class="btn btn-pink" onclick="sellTokens()" style="width: 120px; margin-left: 10px;">æç°</button>
          </div>
        </div>

        <!-- æ¸¸æˆé¢æ¿ -->
        <div class="panel">
          <h3>2. èµŒæ¡Œ (The Table)</h3>
          <div class="row">
            <span style="font-size: 0.9rem;">å½“å‰æˆæƒé¢åº¦: <span id="allowance-amt" class="stat-value" style="color:var(--neon-pink)">0</span></span>
            <button class="btn" onclick="approveToken()" style="width: auto; font-size: 0.8rem; padding: 5px 10px;">æ‰¹å‡†æˆæƒ</button>
          </div>
          <hr style="border-color: #333; margin: 20px 0;">
          
          <div style="text-align: center; margin-bottom: 10px;">ä¸‹æ³¨é‡‘é¢ (CYBER)</div>
          <div class="row" style="justify-content: center;">
            <input type="number" id="bet-amount" placeholder="100" style="width: 200px; font-size: 1.5rem; color: var(--neon-blue);">
          </div>
          
          <div class="row" style="gap: 20px;">
            <button class="btn" onclick="playGame(0)" style="height: 60px; font-size: 1.2rem;">ğŸŸ¢ æŠ¼å° (0-49)</button>
            <button class="btn btn-pink" onclick="playGame(1)" style="height: 60px; font-size: 1.2rem;">ğŸŸ£ æŠ¼å¤§ (50-99)</button>
          </div>

          <div id="game-status" style="text-align: center; margin-top: 25px; font-size: 1.1rem; min-height: 30px; background: rgba(0,0,0,0.3); padding: 10px; border-radius: 5px;">
            ç­‰å¾…ä¸‹æ³¨...
          </div>
        </div>

        <!-- æ—¥å¿— -->
        <div id="console-log">System initialized... Waiting for user connection.</div>
    </div>

    <!-- å³ä¾§ï¼šè¯´æ˜ä¹¦ -->
    <div class="info-section">
        <div class="panel info-text">
            <h3>ğŸ“– æ¸¸æˆæŒ‡å— (Manual)</h3>
            <p><strong>Step 1: è¿æ¥é’±åŒ…</strong><br>ç‚¹å‡»å·¦ä¸Šè§’ Link Start è¿æ¥ MetaMaskï¼Œå¹¶åˆ‡æ¢è‡³ Sepolia æµ‹è¯•ç½‘ã€‚</p>
            
            <p><strong>Step 2: å…‘æ¢ç­¹ç  (DeFi)</strong><br>æ¸¸æˆä½¿ç”¨ <span class="highlight">CYBER</span> ä»£å¸ã€‚åœ¨äº¤æ˜“æ‰€ç”¨æµ‹è¯•å¸ ETH è´­ä¹°ç­¹ç ã€‚ä½ ä¹Ÿå¯ä»¥éšæ—¶å°†ç­¹ç å…‘æ¢å› ETHã€‚</p>
            
            <p><strong>Step 3: æˆæƒ (Approve)</strong><br>é¦–æ¬¡æ¸¸æˆéœ€è¦ç‚¹å‡»â€œæ‰¹å‡†æˆæƒâ€ï¼Œå…è®¸æ™ºèƒ½åˆçº¦ä»ä½ çš„ä½™é¢ä¸­æ‰£é™¤ä¸‹æ³¨é‡‘é¢ã€‚è¿™æ˜¯ ERC-20 æ ‡å‡†çš„å®‰å…¨æœºåˆ¶ã€‚</p>
            
            <p><strong>Step 4: ä¸‹æ³¨ (Bet)</strong><br>è¾“å…¥é‡‘é¢ï¼Œé€‰æ‹©æŠ¼å¤§æˆ–æŠ¼å°ã€‚æ™ºèƒ½åˆçº¦ä¼šç”Ÿæˆéšæœºæ•°ï¼š</br>
            - <span style="color:#0f0">èµ¢</span>ï¼šè·å¾— 2å€ å¥–é‡‘ã€‚</br>
            - <span style="color:#f00">è¾“</span>ï¼šå¤±å»æœ¬é‡‘ã€‚</p>
        </div>

        <div class="panel info-text">
            <h3>âš™ï¸ è°ƒè¯•ä¿¡æ¯</h3>
            <p>Contract Address:</p>
            <p style="font-size: 0.75rem; word-break: break-all; color: #666;">
                Token: 0xc9c764B269DeE0920c93aD8Ce26cF95D52443Be4<br>
                Game: 0xe82137785E77fbA8938A85ca64dEf6de87b1E567
            </p>
            <p style="font-size: 0.8rem; color: #888; margin-top: 10px;">
                * ç¡®ä¿ä½ çš„é’±åŒ…æœ‰ Sepolia ETH ä½œä¸º Gas è´¹ã€‚<br>
                * å¦‚æœä¸€ç›´ Pendingï¼Œè¯·å°è¯•åœ¨ MetaMask åŠ é€Ÿäº¤æ˜“ã€‚
            </p>
        </div>
    </div>

  </div>

  <script>
    // ================= é…ç½®åŒºåŸŸ =================
    const TOKEN_ADDRESS = "0xc9c764B269DeE0920c93aD8Ce26cF95D52443Be4";
    const GAME_ADDRESS = "0xe82137785E77fbA8938A85ca64dEf6de87b1E567";

    const TOKEN_ABI = [
      "function balanceOf(address) view returns (uint)",
      "function buyTokens() payable",
      "function sellTokens(uint amount)",
      "function approve(address spender, uint amount) returns (bool)",
      "function allowance(address owner, address spender) view returns (uint)"
    ];
    const GAME_ABI = [
      "function bet(uint amount, uint8 choice)",
      "event GameResult(address indexed player, uint256 betAmount, bool won, uint256 payout, uint8 diceRoll)"
    ];
    // ===========================================

    let provider, signer, tokenContract, gameContract;
    let userAddress;
    let currentEthBalance = 0;
    let currentTokenBalance = 0;

    function log(msg) {
      const el = document.getElementById("console-log");
      const time = new Date().toLocaleTimeString();
      el.innerHTML = `[${time}] > ${msg}<br>` + el.innerHTML;
    }

    function showLoading(text) {
        document.getElementById("loading-text").innerText = text;
        document.getElementById("loading").style.display = "flex";
    }

    function hideLoading() {
        document.getElementById("loading").style.display = "none";
    }

    async function connectWallet() {
      if (!window.ethereum) return alert("âŒ è¯·å®‰è£… MetaMask");
      
      try {
        const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
        if(accounts.length === 0) return;

        provider = new ethers.providers.Web3Provider(window.ethereum);
        signer = provider.getSigner();
        userAddress = await signer.getAddress();

        tokenContract = new ethers.Contract(TOKEN_ADDRESS, TOKEN_ABI, signer);
        gameContract = new ethers.Contract(GAME_ADDRESS, GAME_ABI, signer);

        document.getElementById("wallet-addr").innerText = "ğŸŸ¢ " + userAddress.substring(0, 6) + "..." + userAddress.slice(-4);
        document.getElementById("connect-btn").innerText = "å·²è¿æ¥";
        document.getElementById("connect-btn").disabled = true;
        
        log("é’±åŒ…å·²è¿æ¥: " + userAddress);
        
        // åˆå§‹åŒ–æ•°æ®
        await updateData();

        // --- æ ¸å¿ƒä¼˜åŒ–ï¼šç›‘å¬åŒºå—å˜åŒ–ï¼Œå®ç°åŠ¨æ€ä½™é¢ ---
        provider.on("block", (blockNumber) => {
            console.log("New block mined: " + blockNumber);
            updateData(); // æ¯ä¸ªæ–°åŒºå—éƒ½åˆ·æ–°ä¸€æ¬¡ä½™é¢
        });

        // ç›‘å¬æ¸¸æˆç»“æœ
        setupGameListener();

        // ç›‘å¬è´¦æˆ·åˆ‡æ¢
        window.ethereum.on('accountsChanged', function (accounts) {
            window.location.reload();
        });

      } catch (e) { console.error(e); alert("è¿æ¥è¢«æ‹’ç»æˆ–å‡ºé”™"); }
    }

    async function updateData() {
      if (!userAddress) return;
      
      try {
          // 1. è·å– ETH ä½™é¢
          const ethBalBN = await provider.getBalance(userAddress);
          currentEthBalance = parseFloat(ethers.utils.formatEther(ethBalBN)); // å­˜ä¸ºå…¨å±€å˜é‡æ–¹ä¾¿æ£€æŸ¥
          document.getElementById("eth-bal").innerText = currentEthBalance.toFixed(4);

          // 2. è·å– Token ä½™é¢
          const tokenBalBN = await tokenContract.balanceOf(userAddress);
          currentTokenBalance = parseFloat(ethers.utils.formatEther(tokenBalBN));
          document.getElementById("token-bal").innerText = currentTokenBalance.toFixed(2);

          // 3. è·å–æˆæƒé¢åº¦
          const allowanceBN = await tokenContract.allowance(userAddress, GAME_ADDRESS);
          document.getElementById("allowance-amt").innerText = parseFloat(ethers.utils.formatEther(allowanceBN)).toFixed(0);
      } catch(e) {
          console.error("æ›´æ–°æ•°æ®å¤±è´¥", e);
      }
    }

    function setupGameListener() {
        gameContract.on("GameResult", (player, amount, won, payout, roll) => {
          if (player === userAddress) {
            const resultText = won ? "WIN! èƒœåˆ©" : "LOSE å¤±è´¥";
            const resultClass = won ? "win" : "lose";
            const payoutEth = ethers.utils.formatEther(payout);
            
            document.getElementById("game-status").innerHTML =
              `<span class="${resultClass}">${resultText}</span> | ç‚¹æ•°: ${roll} | ${won ? '+' + payoutEth : '-'+ethers.utils.formatEther(amount)} CYBER`;
            
            log(`ğŸ² æ¸¸æˆç»“æœ: ${resultText} (ç‚¹æ•°: ${roll})`);
            hideLoading();
            updateData(); // å¼ºåˆ¶ç«‹å³åˆ·æ–°
          }
        });
    }

    // --- äº¤æ˜“é€»è¾‘ ---

    async function buyTokens() {
      const input = document.getElementById("buy-amount");
      const amt = input.value;
      if (!amt || amt <= 0) return alert("è¯·è¾“å…¥æœ‰æ•ˆçš„é‡‘é¢");
      
      // å‰ç«¯æ ¡éªŒï¼šä½™é¢æ£€æŸ¥
      if (parseFloat(amt) > currentEthBalance) {
          return alert(`âŒ ETH ä½™é¢ä¸è¶³ï¼\nå½“å‰ä½™é¢: ${currentEthBalance} ETH`);
      }

      try {
        showLoading("æ­£åœ¨è´­ä¹°ç­¹ç ...");
        const tx = await tokenContract.buyTokens({ value: ethers.utils.parseEther(amt) });
        log("äº¤æ˜“å·²å‘é€: " + tx.hash);
        await tx.wait();
        log("âœ… è´­å¸æˆåŠŸï¼");
        input.value = ""; // æ¸…ç©ºè¾“å…¥æ¡†
        await updateData();
      } catch (e) { 
          log("âŒ äº¤æ˜“å¤±è´¥"); 
          alert("äº¤æ˜“å¤±è´¥: " + (e.reason || e.message));
      } finally { hideLoading(); }
    }

    async function sellTokens() {
      const input = document.getElementById("sell-amount");
      const amt = input.value;
      if (!amt || amt <= 0) return alert("è¯·è¾“å…¥æœ‰æ•ˆçš„é‡‘é¢");

      // å‰ç«¯æ ¡éªŒï¼šCYBER ä½™é¢æ£€æŸ¥
      if (parseFloat(amt) > currentTokenBalance) {
          return alert(`âŒ CYBER ä½™é¢ä¸è¶³ï¼\nå½“å‰ä½™é¢: ${currentTokenBalance} CYBER`);
      }

      try {
        showLoading("æ­£åœ¨æç° (Sell)...");
        const tx = await tokenContract.sellTokens(ethers.utils.parseEther(amt));
        log("æç°äº¤æ˜“å‘é€ä¸­...");
        await tx.wait();
        log("âœ… æç°æˆåŠŸï¼ETH å·²åˆ°è´¦");
        input.value = "";
        await updateData();
      } catch (e) { 
          log("âŒ æç°å¤±è´¥");
          alert("æç°å¤±è´¥: " + (e.reason || e.message));
      } finally { hideLoading(); }
    }

    async function approveToken() {
      try {
        showLoading("æ­£åœ¨è¯·æ±‚æˆæƒ...");
        const tx = await tokenContract.approve(GAME_ADDRESS, ethers.constants.MaxUint256);
        log("æˆæƒäº¤æ˜“å‘é€ä¸­...");
        await tx.wait();
        log("âœ… æˆæƒæˆåŠŸï¼");
        await updateData();
      } catch (e) { 
          log("æˆæƒå–æ¶ˆæˆ–å¤±è´¥"); 
      } finally { hideLoading(); }
    }

    async function playGame(choice) {
      const input = document.getElementById("bet-amount");
      const amt = input.value;
      if (!amt || amt <= 0) return alert("è¯·è¾“å…¥ä¸‹æ³¨é‡‘é¢");
      
      // 1. æ£€æŸ¥ä½™é¢
      if (parseFloat(amt) > currentTokenBalance) {
          return alert("âŒ ç­¹ç ä¸è¶³ï¼Œè¯·å…ˆå»äº¤æ˜“æ‰€è´­ä¹°ï¼");
      }
      
      // 2. æ£€æŸ¥æˆæƒ
      const currentAllowance = document.getElementById("allowance-amt").innerText;
      if (parseFloat(currentAllowance) < parseFloat(amt)) {
          return alert("âŒ æˆæƒé¢åº¦ä¸è¶³ï¼è¯·å…ˆç‚¹å‡»ã€æ‰¹å‡†æˆæƒã€‘æŒ‰é’®ã€‚");
      }

      try {
        showLoading("æ­£åœ¨æŠ•æ·éª°å­ (ç­‰å¾…ä¸Šé“¾)...");
        document.getElementById("game-status").innerHTML = `<span style="color:yellow">ğŸ² éª°å­æ»šåŠ¨ä¸­...</span>`;
        
        // æ˜¾å¼æŒ‡å®š Gas Limit é˜²æ­¢ MetaMask ä¼°ç®—é”™è¯¯
        const tx = await gameContract.bet(ethers.utils.parseEther(amt), choice, { gasLimit: 300000 });
        
        log("ä¸‹æ³¨å·²æäº¤ï¼Œç­‰å¾…ç»“æœ...");
        input.value = ""; // æ¸…ç©ºè¾“å…¥
        // ç»“æœå°†åœ¨ setupGameListener ä¸­å¤„ç†
      } catch (e) {
        console.error(e);
        hideLoading();
        log("âŒ ä¸‹æ³¨å¤±è´¥");
        document.getElementById("game-status").innerText = "äº¤æ˜“å¤±è´¥";
        
        // å°è¯•è§£æé”™è¯¯åŸå› 
        if(e.data && e.data.message && e.data.message.includes("broke")) {
             alert("â˜ ï¸ èµŒåœºç ´äº§äº†ï¼åˆçº¦é‡Œæ²¡é’±èµ”ä½ äº†ã€‚");
        } else {
             alert("äº¤æ˜“å‡ºé”™: " + (e.reason || e.message));
        }
      }
    }
  </script>
</body>

</html>
